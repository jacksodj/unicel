// Formula grammar for unit-aware spreadsheet
// Supports: arithmetic operations, cell references, and literal units

WHITESPACE = _{ " " | "\t" | "\r" | "\n" }

// Main formula rule (optionally starts with =)
formula = { SOI ~ "="? ~ expr ~ EOI }

// Expressions with precedence
expr = { term ~ (add_op ~ term)* }
term = { factor ~ (mul_op ~ factor)* }
factor = { unary_op? ~ primary }

// Operators
add_op = { "+" | "-" }
mul_op = { "*" | "/" }
unary_op = { "-" | "+" }

// Primary expressions
primary = _{
    "(" ~ expr ~ ")" |
    function_call |
    cell_ref |
    named_ref |
    currency_with_number |
    number_with_unit |
    number
}

// Numbers
number = @{ float | integer }
integer = @{ ASCII_DIGIT+ }
float = @{ ASCII_DIGIT+ ~ "." ~ ASCII_DIGIT* | "." ~ ASCII_DIGIT+ }

// Currency-first format (e.g., "$15", "$15.5")
currency_with_number = { "$" ~ number }

// Number with unit (e.g., "100m", "5.5kg", "15$/ft", "50mi/hr")
number_with_unit = { number ~ unit }

// Unit identifier - supports simple units and compound units (division and multiplication)
unit = @{ simple_unit ~ ("/" ~ simple_unit | "*" ~ simple_unit)? }
simple_unit = @{ (ASCII_ALPHA | "$")+ }

// Cell reference (e.g., A1, B12, AA100)
// Must be all uppercase letters followed by digits to distinguish from named refs
cell_ref = @{ col_ref ~ row_ref }
col_ref = @{ ASCII_ALPHA_UPPER+ }
row_ref = @{ ASCII_DIGIT+ }

// Named reference (e.g., revenue, tax_rate, conversion_usd_to_eur)
// Must start with lowercase letter or underscore to distinguish from cell refs
// Can contain letters, numbers, underscores
named_ref = @{ (ASCII_ALPHA_LOWER | "_") ~ (ASCII_ALPHANUMERIC | "_")* }

// Function call (e.g., SUM(A1:A10))
function_call = { function_name ~ "(" ~ arg_list? ~ ")" }
function_name = @{ ASCII_ALPHA+ }
arg_list = { arg ~ ("," ~ arg)* }
arg = { range | expr }

// Cell range (e.g., A1:B10)
range = { cell_ref ~ ":" ~ cell_ref }
