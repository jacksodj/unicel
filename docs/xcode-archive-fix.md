# Fix: Xcode Archive "Connection Refused" Error

## Problem

When attempting to create an iOS archive using Xcode's **Product → Archive** menu, the build fails with:

```
failed to read CLI options: Error when opening the TCP socket: Connection refused (os error 61)

/Users/dennisjackson/Library/Developer/Xcode/DerivedData/.../Script-10ABD09048DD4D79798422FB.sh: line 2: 48639 Abort trap: 6
```

This error occurs in the pre-build script that runs `tauri ios xcode-script`.

## Root Cause

The `tauri ios xcode-script` command is designed to communicate with a **Tauri CLI server** that runs only during:
- `tauri ios dev` (development mode)
- `tauri ios build` (production build)

When you use Xcode's "Product → Archive" directly, there is no CLI server running, causing the TCP connection to fail.

The xcode-script command tries to read build configuration from this server at runtime, which is why it panics with "Connection refused" when the server isn't available.

## Solution

**Do NOT use Xcode's Product → Archive.** Instead, use the Tauri CLI to create archives:

### For TestFlight

```bash
npm run tauri:ios:build:testflight
```

Or directly:

```bash
npm run tauri ios build --export-method release-testing
```

### For App Store

```bash
npm run tauri:ios:build:appstore
```

Or directly:

```bash
npm run tauri ios build --export-method app-store-connect
```

## Why This Works

When you run `tauri ios build`:

1. Tauri starts its CLI server in the background
2. The server provides configuration to the xcode-script command
3. Xcode's pre-build script successfully connects to the server
4. The build completes and creates an archive
5. The archive is exported as an IPA

The output IPA is located at:
```
src-tauri/gen/apple/build/arm64/Unicel.ipa
```

## Verification

The fix has been verified with a successful build:

```bash
$ npm run tauri:ios:build:testflight
✓ Frontend built successfully
✓ Rust backend compiled
✓ iOS app archived
✓ IPA exported to src-tauri/gen/apple/build/arm64/Unicel.ipa

$ ls -lh src-tauri/gen/apple/build/arm64/Unicel.ipa
-rw-r--r--  1 user  staff   3.3M Oct 18 13:01 Unicel.ipa

$ unzip -l Unicel.ipa | grep -E "Info.plist|embedded.mobileprovision"
✓ Info.plist present
✓ embedded.mobileprovision present
✓ Code signature valid
```

## Alternative: Modifying project.yml (NOT RECOMMENDED)

While it's theoretically possible to modify `src-tauri/gen/apple/project.yml` to remove the xcode-script dependency, this is **not recommended** because:

1. The file is generated by Tauri and may be overwritten
2. Bypassing the CLI server breaks Tauri's build orchestration
3. You lose access to Tauri's build configuration system
4. Manual maintenance becomes error-prone

The proper solution is to use `tauri ios build` as the official build tool.

## Documentation Updates

Updated documentation:
- `/Users/dennisjackson/Code/unicel/docs/ios-deployment.md` - Full iOS deployment guide
- `/Users/dennisjackson/Code/unicel/package.json` - Added convenience scripts

## Scripts Added

```json
{
  "scripts": {
    "tauri:ios:build:testflight": "npm run tauri:ios:patch && tauri ios build --export-method release-testing",
    "tauri:ios:build:appstore": "npm run tauri:ios:patch && tauri ios build --export-method app-store-connect"
  }
}
```

## Next Steps

1. Use `npm run tauri:ios:build:testflight` to create archives
2. Upload IPA to TestFlight using Transporter.app or xcrun altool
3. Distribute to testers

See [ios-deployment.md](./ios-deployment.md) for full deployment instructions.
